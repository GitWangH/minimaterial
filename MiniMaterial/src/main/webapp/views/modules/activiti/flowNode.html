<!DOCTYPE html>
<html>
<head>
<title>流程节点设置</title>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
<link rel="stylesheet" href="../../../../static/css/bootstrap.min.css">
<link rel="stylesheet" href="../../../../static/css/bootstrapValidator.min.css">
<link rel="stylesheet" href="../../../../static/css/font-awesome.min.css">
<link rel="stylesheet" href="../../../../static/plugins/jqgrid/ui.jqgrid-bootstrap.css">
<link rel="stylesheet" href="../../../../static/css/fieldsetstyle.css">
<link rel="stylesheet" href="../../../../static/plugins/ztree/css/zTreeStyle/zTreeStyle.css"/>
<link rel="stylesheet" href="../../../../static/plugins/layui/css/layui.css"/>


<script src="../../../../static/libs/jquery.min.js"></script>
<script src="../../../../static/libs/bootstrap.min.js"></script>
<script src="../../../../static/libs/bootstrapValidator.min.js"></script>
<script src="../../../../static/libs/vue.min.js"></script>
<script src="../../../../static/plugins/jqgrid/grid.locale-cn.js"></script>
<script src="../../../../static/plugins/jqgrid/jquery.jqGrid.min.js"></script>
<script src="../../../../static/js/common.js"></script>

<script type="text/javascript" src="../../../../static/plugins/ztree/jquery.ztree.all.min.js"></script>
<script type="text/javascript" src="../../../../static/plugins/layer/layer.js"></script>
<script type="text/javascript" src="../../../../static/plugins/layui/layui.js"></script>
<script type="text/javascript" src="../../../../static/plugins/layui/lay/modules/form.js"></script>
<script type="text/javascript" src="../../../../static/plugins/layui/lay/modules/element.js"></script>
<script type="text/javascript" src="../../../../static/plugins/layer/mylayer.js"></script>

</head>
<body>
<div class="main-container" id="main-container">
			<div class="row" style="margin-left: 20px;margin-top: 20px;">
				<div class="col-md-3 panel panel-default">
					<div style="font-size: 20px;margin-bottom: 10px">
						<i class="layui-icon" style="font-size: 20px; color: #009688;">&#xe62e;</i> 流程节点树
					</div>
					<div class="panel-body" style="padding: 10px;">
						<ul id="modelTree" class="ztree" ></ul>
					</div>
				</div>
				<div class="col-md-7 panel panel-default" style="margin-left: 100px">
					<div style="font-size: 20px;margin-bottom: 10px">
						<i class="layui-icon panel-title" style="font-size: 20px; color: #009688;">&#xe63c;</i> 节点信息
					</div>
					<div class="row form-content">
						<div class="col-xs-12">
							<form class="form-horizontal  bv-form" id="flowSetForm" action="#">
								<div style="display: none">
									<input name="nodeId"/>
									<input name="id"/>
									<input name="modelId"/>
								</div>
								<div class="row">
									<div class="col-md-3">
										<div class="input-group">
							    			<div class="input-group-btn">
							        			<label  class="btn btn-white">名称:</label>
							    			</div>
							    			<input id="name" name="name" type="text" class="form-control" disabled style="width:80px;"/>
										</div>
									</div>
									<div class="col-md-3">
										<div class="input-group">
										    <div class="input-group-btn">
										        <label  class="btn btn-white">类型:</label>
										    </div>
										    <select name="nodeType" class="form-control" readonly="true" style="width:120px;">
												<option value="1">开始节点</option>
												<option value="2">审批节点</option>
												<option value="3">分支</option>
												<option value="4">连线 </option>
												<option value="5">结束节点 </option>
											</select>
										</div>
									</div>
								</div>
									<!-- <div class="form-group col-sm-6 col-md-5 ">
										<label class="col-sm-4 control-label">名称:</label>
										<div class="col-sm-8">
												<input id="name" name="name" type="text"  class="form-control" disabled />
										</div>
									</div>
									<div class="form-group col-sm-6 ">
										<label class="col-sm-4 control-label">类型:</label>
										<div class="col-sm-8">
												<select name="nodeType" class="form-control" readonly="true">
													<option value="1">开始节点</option>
													<option value="2">审批节点</option>
													<option value="3">分支</option>
													<option value="4">连线 </option>
													<option value="5">结束节点 </option>
												</select>
										</div>
										<div class="readOnly"></div>
									</div> -->
									<div class="row">
										<div class="col-md-3" isHide="2">
											<div class="input-group">
											    <div class="input-group-btn">
											        <label  class="btn btn-white">行为:</label>
											    </div>
											    <select name=nodeAction class="form-control" readonly="true" style="width:80px;margin-top:10px;">
														<option value="1">审批</option>
														<option value="2">会签</option>
												</select>
											</div>
										<!-- <div class="form-group col-sm-6 col-md-5 "  isHide="2">
											<label class="col-sm-4 control-label no-padding-right">行为:</label>
											<div class="col-sm-8">
													<select name=nodeAction class="form-control" readonly="true">
														<option value="1">审批</option>
														<option value="2">会签</option>
													</select>
											</div>
											<div class="readOnly"></div>
										</div> -->
										
									</div>
								</div>
								<div isHide="2">
									<button class="layui-btn layui-btn-small" type="button" onclick="userWindow()"><i class="layui-icon">&#xe612;</i>审批范围</button>
								</div>
								<table id="userTab" class="layui-table" isHide="2">
									<thead>
									<tr>
										<th>类型</th>
										<th>名称</th>
										<th>操作</th>
									</tr>
									</thead>
									<tbody>

									</tbody>
								</table>
								
								<div class="row" style="margin-left: 180px;padding-bottom: 28px;margin-top: 25px;">
									<button class="layui-btn" type="button" id="submitBtn">保 存</button>
									<button class="layui-btn layui-btn-primary" type="button" onclick="closeThisWindow()">关 闭</button>
								</div>
							</form>
						</div>
					</div>
				</div><!-- /.col-lg-6 -->
			</div><!-- /.row -->
		</div>


<!-- <script src="../../../../static/js/modules/activiti/flowNode.js"></script> -->

<script>
		 $(function () {
			 //页面加载都隐藏
			 $("[isHide]").hide();
             $("#flowSetForm select[name='nodeType']").on("change",function(){
            	 debugger ;
                 $("[isHide]").hide();
                 $("[isHide*='"+$(this).val()+"'").show();
             });
         });
		
        var setting = {
            view: {dblClickExpand: false}
            ,data: {key: {name:"treeName"},simpleData: {enable: true,idKey: "treeId",pIdKey: "treePid"}}
            ,callback: {onClick: zTreeOnClick}
        };
        
        $(function(){
        	debugger ;
        	var modelId  = getUrlVar('modelId');
        	
        	var url =baseURL+"act/model/showflow" ;
			$.ajax({
		          url: url,
		          type: "GET",
		          dataType: "json",
		          data: {
		        	 'modelId' :modelId,
		          },
		          success: function(r) {
		        	  debugger ;
		        	  var data=r.flows;
		              var ztreeobj=$.fn.zTree.init($("#modelTree"), setting, eval(''+data+''));//ztree树加载
		              ztreeobj.expandAll(true);
		          },
		          error: function() {
		        	  alert(data.msg);
		          }
		     }); 
        });

        /**
		 * 节点单击事件
         */
        function zTreeOnClick(event, treeId, treeNode) {
            //清空表单信息
            $("#flowSetForm")[0].reset();
            debugger ;
            $("#flowSetForm input[name='name']").val(treeNode.treeName);
            $("#flowSetForm input[name='nodeId']").val(treeNode.treeId);
            $("#flowSetForm input[name='modelId']").val(treeNode.modelId);
            var selectChange=$("#flowSetForm select[name='nodeType']").val(treeNode.type)[0];
            simulateClick(selectChange);
        	var url =baseURL+"act/model/flowSetInfo" ;
			var params={
			    nodeId:treeNode.treeId,
				type:treeNode.type
            }
            $.post(url,params,function (result) {
            	debugger ;
				if(result.success ){
					var nodeSet = result.nodeSet;
					if(nodeSet){
                        formload("flowSetForm",nodeSet);
					}
					//审批范围
                    var userLists = result.userList;
					debugger ;
					var typeName = '用户';
	                var userTypes = '1';
	                  
                    if(userLists){
                        var html="";
						for (var i=0;i<userLists.length;i++){
                            html+="<tr id='"+userLists[i].id+"'>";
                            html+="  <td>"+typeName+"</td>";
                            html+="  <td style='display: none'>";
                            html+="  	<input name='userTypes' value='"+userLists[i].userType+"'/>";
                            html+="  	<input name='userIds' value='"+userLists[i].id+"'/>";
                            html+="  </td>";
                            html+="  <td>"+userLists[i].userTitle+"</td>";
                            html+='<td><button type="button" onclick="delUser(this)" class="btn btn-xs btn-white btn-danger"><i class="fa fa-trash-o"></i> 删 除 </button></td>';
                            html+="</tr>";
						}
						$("#userTab tbody").html(html);
                    }
					//节点条件
                   /*  var fields = result.fields;
                    if(fields){
						for(var i=0;i<fields.length;i++){
                            simulateClick($("#flowSetForm select[name='judgList["+i+"].fieldName']").val(fields[i].fieldName)[0]);
                            $("#flowSetForm select[name='judgList["+i+"].rule']").val(fields[i].rule);
                            $("#flowSetForm input[name='judgList["+i+"].fieldVal']").val(fields[i].fieldVal);
                            simulateClick($("#flowSetForm select[name='judgList["+i+"].elOperator']").val(fields[i].elOperator)[0]);
						}
                    } */
				}else {
				    alertMsg(result.msg);
				}
            });
        };


        //条件增加 待开发
        function addActRule() {
			$("#actRules").append();
        }

         /**
		  * 选择审批范围
          */
         function userWindow() {
             layer.open({
                 type: 2,
                 offset: '50px',
                 skin: 'layui-layer-molv',
                 title: "选择客户",
                 area: ['80%', '80%'],
                 shade: 0,
                 shadeClose: false,
                 content:  baseURL + 'views/modules/activiti/selectUser.html',
                 btn: ['确定', '取消'],
                 btn1: function (index, layero) {
                 	debugger ;
                 	 //当点击‘确定’按钮的时候，获取弹出层返回的值
                     var selectData = window["layui-layer-iframe" + index].selectUserCallback();
                     console.log(selectData);
                     if(null != selectData){
                    	 var flag = true;
	                   	 $("#userTab").find("tr").each(function () {
                              var trid = $(this).attr("id");
                              if(trid ==selectData.userId){
              					flag =false;
                              }
	                      })
	                      var typeName = '用户';
	 	                  var userTypes = '1';
	                      if(flag){
	                    	  debugger ;
	 	                     var html="";
	 	                     html+="<tr id='"+selectData.userId+"'>";
	 	                     html+="  <td>"+typeName+"</td>";
	 	                     html+="  <td style='display: none'>";
	 	                     html+="  	<input name='userTypes' value='"+userTypes+"'/>";
	 	                     html+="  	<input name='userIds' value='"+selectData.userId+"'/>";
	 	                     html+="  </td>";
	 	                     html+="  <td>"+selectData.username+"</td>";
	 	                     html+='<td><button type="button" onclick="delUser(this)" class="btn btn-xs btn-white btn-danger"><i class="fa fa-trash-o"></i> 删 除 </button></td>';
	 	                     html+="</tr>";
	 	                     $("#userTab").append(html);
	                      }
                     }
 	              	//最后关闭弹出层
                 	layer.close(index);
                 }
             });
             
         }

         /**
		  * 删除审批人
          */
         function delUser(_this) {
			$(_this).parent().parent().remove();
         }

         /**
		  * 保存节点信息
          */
         $("#submitBtn").click(function () {
             var url=baseURL+"act/model/saveNode";
             debugger ;
             var data = $("#flowSetForm").serialize();
			 $.post(url,data,function (result) {
                 if(result.success){
                	 toast(result.msg);
					var nodeSet = result.nodeSet;
					$("#flowSetForm input[name='id']").val(nodeSet.id);
                 }else {
                     alertMsg(result.msg);
                 }
             });
         });

         /**
		  * 条件限制　待完善
          */
         $("#flowSetForm select[name$='fieldName']").off().on("change",function () {

         });

         
         function simulateClick(el) {
             if(el){
                 var evt;
                 if (document.createEvent) { // DOM Level 2 standard
                     evt = document.createEvent("MouseEvents");
                     evt.initMouseEvent("change", true, true, window,
                         0, 0, 0, 0, 0, false, false, false, false, 0, null);
                     el.dispatchEvent(evt);
                 } else if (el.fireEvent) { // IE
                     el.fireEvent('onchange');
                 }
             }
         }

         function getAllChildNodes(treeNode, childs) {
             if(treeNode.isParent){
                 var childNodes = treeNode.children;
                 if(childNodes){
                     for (var i=0;i<childNodes.length;i++){
                         childs+=childNodes[i].id+",";
                         if(childNodes[i].isParent){
                             childs=getAllChildNodes(childNodes[i],childs);
                         }
                     }
                 }
             }
             return childs;
         }

         function getAllNodes(treeNode, childs) {
             var childNodes = treeNode.children;
             if(childNodes){
                 for (var i=0;i<childNodes.length;i++){
                     childs+="," + childNodes[i].id;
                     if(childNodes){
                         childs=getAllNodes(childNodes[i],childs);
                     }
                 }
             }
             return childs;
         }

         function in_array(search,array){
             for(var i in array){
                 if(array[i]==search){
                     return true;
                 }
             }
             return false;
         }
         
         function formload(form,data){
             for(var name in data){
                 var val=data[name];
                 //var rr=$("input[name=\""+name+"\"][type=radio], input[name=\""+name+"\"][type=checkbox]",form);
                 var rr=$("#"+form+" input[name='"+name+"'][type=checkbox],input[name='"+name+"'][type=radio]");
                 $.fn.prop?rr.prop("checked",false):rr.attr("checked",false);
                 rr.each(function(){
                     var f=$(this);
                     var valarray =String(val).split(",");
                     if(in_array(f.val(),valarray)){
                         $.fn.prop?f.prop("checked",true):f.attr("checked",true);
                     }
                 });
                 if(!rr.length){
                     $("#"+form+" input[name=\""+name+"\"]").val(val);
                     $("#"+form+" textarea[name=\""+name+"\"]").val(val);
                     simulateClick($("#"+form+" select[name=\""+name+"\"]").val(val)[0]);
                 }
             }
         }

         //åå§åè¡¨åéªè¯ç»æ --å é¤è¡¨åçéªè¯ä¿¡æ¯
         function initValidForm(obj){
             obj.find("span.Validform_checktip").empty().removeClass("Validform_wrong Validform_right");//ç§»é¤è¡¨åä¸­éªè¯ä¿¡æ¯
             obj.find("select,input,textarea").removeClass("Validform_error");//ç§»é¤è¡¨åä¸­éªè¯ä¿¡æ¯
         }

         //éªè¯divä¸­ æ¯å¦ æ»¡è¶³ éªè¯æ¡ä»¶
         //åæ°ï¼æä¸ªè¡¨åå¯¹è±¡ãéªè¯æååæ§è¡çå½æ°
         function checkFormValid(formObj,fun){
             var childSaveBtn=formObj.find("#child_SaveBtn");//æ¥æ¾formä¸çid="child_SaveBtn";
             if(childSaveBtn==null||childSaveBtn.length==0){
                 formObj.append('<input type="button" id="child_SaveBtn" style="display:none;"/>');//ä¸ºformåç´ ç»å°¾ï¼ä»ç¶å¨åé¨ï¼æå¥æé®
                 childSaveBtn=formObj.find("#child_SaveBtn");
             }
             formObj.Validform({
                 btnSubmit:"#child_SaveBtn",
                 tiptype:function(msg,o,cssctl){
                     o.obj.parent().find(".Validform_checktip").remove();
                     o.obj.parent().append("<span class='Validform_checktip' />");
                     var objtip=o.obj.parent().find(".Validform_checktip");
                     cssctl(objtip,o.type);
                     objtip.text(msg);
                     //msgï¼æç¤ºä¿¡æ¯;
                     //o:{obj:*,type:*,curform:*}, objæåçæ¯å½åéªè¯çè¡¨ååç´ ï¼æè¡¨åå¯¹è±¡ï¼ï¼typeæç¤ºæç¤ºçç¶æï¼å¼ä¸º1ã2ã3ã4ï¼ 1ï¼æ­£å¨æ£æµ/æäº¤æ°æ®ï¼2ï¼éè¿éªè¯ï¼3ï¼éªè¯å¤±è´¥ï¼4ï¼æç¤ºignoreç¶æ, curformä¸ºå½åformå¯¹è±¡;

                     //cssctl:åç½®çæç¤ºä¿¡æ¯æ ·å¼æ§å¶å½æ°ï¼è¯¥å½æ°éä¼ å¥ä¸¤ä¸ªåæ°ï¼æ¾ç¤ºæç¤ºä¿¡æ¯çå¯¹è±¡ å å½åæç¤ºçç¶æï¼æ¢å½¢åoä¸­çtypeï¼;
                     /*if(!o.obj.is("form")){//éªè¯è¡¨ååç´ æ¶o.objä¸ºè¯¥è¡¨ååç´ ï¼å¨é¨éªè¯éè¿æäº¤è¡¨åæ¶o.objä¸ºè¯¥è¡¨åå¯¹è±¡;
                      var oobjtip=o.obj.siblings(".Validform_checktip");
                      cssctl(objtip,o.type);
                      objtip.text(msg);
                      }  */
                 },
                 showAllError:false,//trueï¼æäº¤è¡¨åæ¶ææéè¯¯æç¤ºä¿¡æ¯é½ä¼æ¾ç¤ºï¼falseï¼ä¸ç¢°å°éªè¯ä¸éè¿çå°±åæ­¢æ£æµåé¢çåç´ ï¼åªæ¾ç¤ºè¯¥åç´ çéè¯¯ä¿¡æ¯;
                 beforeSubmit:function(curform){
                     //å¨éªè¯æååï¼è¡¨åæäº¤åæ§è¡çå½æ°ï¼curformåæ°æ¯å½åè¡¨åå¯¹è±¡ã
                     //è¿éæç¡®return falseçè¯è¡¨åå°ä¸ä¼æäº¤;
                     fun();
                     return false;
                 }
             });
             childSaveBtn.click();
         }
         

	</script>
	
	
</body>
</html>